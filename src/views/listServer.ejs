<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Servidores</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .fade-in {
      animation: fadeIn 0.2s ease-out;
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }
  </style>
</head>

<body class="bg-[#0a0a0a] text-gray-100 min-h-screen">

  <main class="w-full md:max-w-[80%] mx-auto p-6 pb-24">
    <!-- Header aprimorado -->
    <header class="mb-8">
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-3xl font-bold text-gray-300 hidden md:block">
          Lista de Servidores
        </h1>
        <div class="flex items-center gap-5">
          <button
            class="px-4 py-2 bg-green-400/10 hover:bg-green-400/20 border border-green-400/30 hover:border-green-400/50 text-green-400 rounded-lg transition-all duration-200 font-semibold text-sm flex items-center gap-2">
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01">
              </path>
            </svg>
            Servidor central
          </button>
        </div>
      </div>
      <p class="text-sm text-gray-500 mb-6">Gerencie e monitore todos os seus sub-servidores</p>

      <!-- Campo de busca aprimorado -->
      <div class="relative">
        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input id="searchInput" type="text" placeholder="Buscar por ID, Nome, CNPJ ou Porta..."
          class="w-full pl-12 pr-4 py-3 rounded-xl bg-[#151515] border border-[#2d2d2d] text-gray-200 placeholder-gray-500 outline-none focus:border-green-500/50 focus:bg-[#1a1a1a] transition-all" />
      </div>
    </header>

    <!-- Tabela aprimorada -->
    <div class="overflow-hidden bg-[#151515] border border-[#2d2d2d] rounded-xl shadow-2xl mb-8">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-[#2d2d2d]">
          <thead class="bg-[#1a1a1a]">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">ID</th>
              <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Nome</th>
              <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">CNPJ</th>
              <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Porta</th>
              <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Dominio</th>
              <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Criado em
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-400">Ações</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[#2d2d2d]">
            <% if (Array.isArray(Many) && Many.length) { %>
              <% const sortedMany=[...Many].sort((a, b)=> (b.port || 0) - (a.port || 0));
                %>
                <% sortedMany.forEach(item=> { %>
                  <tr class="hover:bg-[#1a1a1a] transition-colors duration-150">
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                      <button onclick="copy(`<%= item.id %>`)"
                        class="bg-indigo-300/10 text-slate-300 pl-3 rounded-md font-mono text-xs flex items-center gap-3 justify-between">
                        <%= item.id %>
                          <div class="bg-slate-400/20 rounded-lg p-2">
                            <svg width="12px" height="12px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                              </path>
                            </svg>
                          </div>
                      </button>
                    </td>



                    <td class="px-6 py-4 text-sm whitespace-nowrap font-medium">
                      <%= item.businessName %>
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap font-mono text-gray-400">
                      <%= item.cnpj %>
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                      <span class="px-3 py-2 bg-blue-500/10 text-blue-400 rounded-md font-mono text-xs">
                        <%= item.port %>
                      </span>
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                      <a href="https://<%= item.domain %>"
                        class="bg-indigo-300/10 text-indigo-300 pl-3 rounded-md font-mono text-xs flex items-center gap-3 justify-between">
                        <%= item.domain %>
                          <div class="bg-indigo-400/20 rounded-lg p-2">
                            <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg"
                              viewBox="0 0 122.88 122.88" width="12px" height="12px" class="fill-indigo-300">
                              <title>hyperlink</title>
                              <path
                                d="M60.54,34.07A7.65,7.65,0,0,1,49.72,23.25l13-12.95a35.38,35.38,0,0,1,49.91,0l.07.08a35.37,35.37,0,0,1-.07,49.83l-13,12.95A7.65,7.65,0,0,1,88.81,62.34l13-13a20.08,20.08,0,0,0,0-28.23l-.11-.11a20.08,20.08,0,0,0-28.2.07l-12.95,13Zm14,3.16A7.65,7.65,0,0,1,85.31,48.05L48.05,85.31A7.65,7.65,0,0,1,37.23,74.5L74.5,37.23ZM62.1,89.05A7.65,7.65,0,0,1,72.91,99.87l-12.7,12.71a35.37,35.37,0,0,1-49.76.14l-.28-.27a35.38,35.38,0,0,1,.13-49.78L23,50A7.65,7.65,0,1,1,33.83,60.78L21.12,73.49a20.09,20.09,0,0,0,0,28.25l0,0a20.07,20.07,0,0,0,28.27,0L62.1,89.05Z" />
                            </svg>
                          </div>
                      </a>
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap text-gray-400">
                      <%= item.createdAt ? new Date(item.createdAt).toLocaleString('pt-BR') : "-" %>
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                      <% const isRunning=Array.isArray(runningSites) && runningSites.some(s=> s.port == item.port);
                        %>
                        <div class="flex gap-2">
                          <% if (isRunning) { %>
                            <span
                              class="px-4 py-2 bg-gray-500/5 border border-gray-500/20 text-gray-500 rounded-lg cursor-not-allowed font-medium text-xs">
                              Aberto!
                            </span>
                            <% } else { %>
                              <a href="/business/servers/open/<%= item.port %>" target="_blank" onclick="reload()"
                                class="px-4 py-2 bg-green-500/10 hover:bg-green-500/20 border border-green-500/20 hover:border-green-500/40 text-green-400 rounded-lg transition-all duration-200 font-medium text-xs">
                                Abrir
                              </a>
                              <% } %>

                                <% if (isRunning) { %>
                                  <a href="/business/servers/stop/<%= item.port %>" onclick="reload()"
                                    class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 hover:border-red-500/40 text-red-400 rounded-lg transition-all duration-200 font-medium text-xs">
                                    Fechar
                                  </a>
                                  <% } else { %>
                                    <span
                                      class="px-4 py-2 bg-gray-500/5 border border-gray-500/20 text-gray-500 rounded-lg cursor-not-allowed font-medium text-xs">
                                      Fechado
                                    </span>
                                    <% } %>
                        </div>
                    </td>
                  </tr>
                  <% }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="12" class="px-6 py-12 text-center">
                          <div class="flex flex-col items-center justify-center text-gray-500">
                            <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor"
                              viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                              </path>
                            </svg>
                            <p class="text-sm">Nenhum registro encontrado</p>
                          </div>
                        </td>
                      </tr>
                      <% } %>
          </tbody>
        </table>
      </div>

      <!-- Botão Parar Tudo na parte inferior da tabela -->
      <div class="border-t border-[#2d2d2d] bg-[#1a1a1a] px-6 py-4">
        <div class="flex justify-end gap-3 flex-wrap">
          <button onclick="openUsageDialog()"
            class="px-4 py-2 max-sm:w-full truncate bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 hover:border-blue-500/50 text-blue-400 rounded-lg transition-all duration-200 font-semibold text-sm flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
              </path>
            </svg>
            Monitoramento
          </button>
          <button onclick="openStopAllDialog()"
            class="px-6 py-2.5 max-sm:w-full truncate  bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 hover:border-red-500/50 text-red-400 rounded-lg transition-all duration-200 font-semibold text-sm flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Parar Todos os Servidores
          </button>
        </div>
      </div>
    </div>

    <!-- Console aprimorado -->
    <section>
      <header class="mb-4 flex items-center justify-between">
        <div>
          <h2 class="text-xl font-bold text-gray-200">Console de Monitoramento</h2>
          <p class="text-sm text-gray-500 mt-1">Status em tempo real dos servidores</p>
        </div>
        <div class="text-sm text-gray-400">
          Total: <span class="text-green-400 font-bold text-lg ml-1">
            <%= Array.isArray(runningSites) ? runningSites.length : 0 %>
          </span>
        </div>
      </header>

      <% const displaySites=Array.isArray(runningSites) ? runningSites.map(s=> ({
        businessName: s.businessName ?? '',
        port: s.port ?? '',
        dir: s.dir ?? '',
        pid: s.process && s.process.pid ? s.process.pid : null,
        domain: s.domain ?? '',
        killed: s.process && typeof s.process.killed !== 'undefined' ? !!s.process.killed : null
        })) : [];
        %>

        <!-- Cards de servidores -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 mb-6">
          <% if (displaySites.length) { %>
            <% displaySites.forEach(site=> {
              const status = site.killed === null ? 'unknown' : (site.killed ? 'stopped' : (site.pid ? 'running' :
              'unknown'));
              const statusColors = {
              running: 'border-green-500/30 bg-green-500/5',
              stopped: 'border-red-500/30 bg-red-500/5',
              unknown: 'border-yellow-500/30 bg-yellow-500/5'
              };
              %>
              <div data-console-card
                class="bg-[#151515] border-2 <%= statusColors[status] %> rounded-xl p-5 shadow-lg hover:shadow-xl transition-all duration-200">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1 min-w-0">
                    <a href="https://<%= site.domain %>" target="_blank">
                      <button
                        class="px-2 py-1 mb-2 bg-indigo-300/10 text-indigo-300 rounded-md font-mono text-[14px] flex items-center gap-2">
                        <%= site.businessName %>
                          <div>
                            <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg"
                              viewBox="0 0 122.88 122.88" width="12px" height="12px" class="fill-indigo-400">
                              <title>hyperlink</title>
                              <path
                                d="M60.54,34.07A7.65,7.65,0,0,1,49.72,23.25l13-12.95a35.38,35.38,0,0,1,49.91,0l.07.08a35.37,35.37,0,0,1-.07,49.83l-13,12.95A7.65,7.65,0,0,1,88.81,62.34l13-13a20.08,20.08,0,0,0,0-28.23l-.11-.11a20.08,20.08,0,0,0-28.2.07l-12.95,13Zm14,3.16A7.65,7.65,0,0,1,85.31,48.05L48.05,85.31A7.65,7.65,0,0,1,37.23,74.5L74.5,37.23ZM62.1,89.05A7.65,7.65,0,0,1,72.91,99.87l-12.7,12.71a35.37,35.37,0,0,1-49.76.14l-.28-.27a35.38,35.38,0,0,1,.13-49.78L23,50A7.65,7.65,0,1,1,33.83,60.78L21.12,73.49a20.09,20.09,0,0,0,0,28.25l0,0a20.07,20.07,0,0,0,28.27,0L62.1,89.05Z" />
                            </svg>
                    </a>
                  </div>
                  </button>
                  <div class="text-xs text-gray-500 truncate font-mono">
                    <%= site.dir %>
                  </div>
                </div>
                <div class="ml-4 text-right flex-shrink-0">
                  <div class="text-xs font-medium text-gray-400 mb-1">Porta</div>
                  <div class="px-2 py-1 bg-blue-500/10 text-blue-400 rounded-md font-mono text-sm font-bold">
                    <%= site.port %>
                  </div>
                </div>
              </div>

              <div class="flex items-center justify-between pt-3 border-t border-[#2d2d2d]">
                <div class="text-xs text-gray-500">
                  PID: <span class="text-sm text-gray-300 font-mono">
                    <%= site.pid ?? '-' %>
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  <% if (status==='running' ) { %>
                    <span class="flex items-center gap-1.5 text-xs font-semibold text-green-400">
                      <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                      Online
                    </span>
                    <% } else if (status==='stopped' ) { %>
                      <span class="flex items-center gap-1.5 text-xs font-semibold text-red-400">
                        <span class="w-2 h-2 bg-red-400 rounded-full"></span>
                        Parado
                      </span>
                      <% } else { %>
                        <span class="flex items-center gap-1.5 text-xs font-semibold text-yellow-400">
                          <span class="w-2 h-2 bg-yellow-400 rounded-full"></span>
                          Desconhecido
                        </span>
                        <% } %>
                </div>
              </div>
        </div>
        <% }) %>
          <% } else { %>
            <div class="col-span-2 text-center py-12 text-gray-500">
              <svg class="w-16 h-16 mx-auto mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                </path>
              </svg>
              <p class="text-sm">Nenhum servidor em execução</p>
            </div>
            <% } %>
              </div>

              <!-- Raw JSON -->
              <div class="bg-[#0d0d0d] border border-[#2d2d2d] rounded-xl overflow-hidden">
                <div class="flex items-center justify-between px-5 py-3 bg-[#151515] border-b border-[#2d2d2d]">
                  <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Raw JSON</div>
                  <button onclick="copyJSON()"
                    class="text-xs text-gray-400 hover:text-gray-200 transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                      </path>
                    </svg>
                    Copiar
                  </button>
                </div>
                <pre id="jsonData"
                  class="font-mono text-xs leading-6 p-5 max-h-96 overflow-auto text-green-400"><%= JSON.stringify(displaySites, null, 2) %></pre>
              </div>
    </section>

    <!-- Botão de Help -->
    <a href="/help">
      <button
        class="fixed bottom-6 right-6 px-6 py-3 bg-green-500/10 hover:bg-green-500/20 border border-green-500/30 hover:border-green-500/50 text-green-400 rounded-xl transition-all duration-200 font-semibold text-sm shadow-lg hover:shadow-xl flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
          </path>
        </svg>
        Ajuda
      </button>
    </a>
  </main>

  <!-- Dialog de Confirmação -->
  <div id="stopAllDialog" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 fade-in">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeStopAllDialog()"></div>
    <div class="relative bg-[#151515] border border-red-500/30 rounded-2xl shadow-2xl max-w-md w-full slide-up">
      <div class="p-6">
        <div class="w-16 h-16 mx-auto mb-4 bg-red-500/10 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
            </path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-center mb-2 text-gray-100">Confirmar Ação Crítica</h3>
        <p class="text-sm text-center text-gray-400 mb-6">
          Esta ação irá parar <strong class="text-red-400">TODOS</strong> os servidores em execução. Esta operação não
          pode ser desfeita.
        </p>
        <div class="mb-6">
          <label class="block text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wider">
            Digite "CLOSE ALL" para confirmar:
          </label>
          <input type="text" id="confirmInput" placeholder="CLOSE ALL"
            class="w-full px-4 py-3 bg-[#0d0d0d] border border-[#2d2d2d] rounded-lg text-gray-200 placeholder-gray-600 outline-none focus:border-red-500/50 font-mono text-center text-lg tracking-wider"
            autocomplete="off" />
          <p id="errorMessage" class="hidden text-xs text-red-400 mt-2 text-center font-medium">
            ✕ O texto não corresponde. Digite exatamente "CLOSE ALL"
          </p>
        </div>
        <div class="flex gap-3">
          <button onclick="closeStopAllDialog()"
            class="flex-1 px-4 py-3 bg-[#1a1a1a] hover:bg-[#202020] border border-[#2d2d2d] text-gray-300 rounded-lg transition-all duration-200 font-semibold">
            Cancelar
          </button>
          <button onclick="confirmStopAll()"
            class="flex-1 px-4 py-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 hover:border-red-500/50 text-red-400 rounded-lg transition-all duration-200 font-semibold">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dialog de Monitoramento de Uso -->
  <div id="usageDialog" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 fade-in">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeUsageDialog()"></div>
    <div
      class="relative bg-[#151515] rounded-2xl shadow-2xl max-w-4xl w-full slide-up max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-6 border-b border-[#2d2d2d]">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-gray-100">Monitoramento de Recursos</h3>
            <p class="text-sm text-gray-400 mt-1">Consumo detalhado de CPU, RAM</p>
          </div>
          <button onclick="closeUsageDialog()" class="text-gray-400 hover:text-gray-200 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="p-6 overflow-y-auto flex-1">
        <div id="usageContent" class="space-y-4">
          <div class="text-center text-gray-400 py-8">
            <svg class="w-12 h-12 mx-auto mb-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
              </path>
            </svg>
            <p class="text-sm">Carregando dados...</p>
          </div>
        </div>
      </div>

      <div class="p-4 border-t border-[#2d2d2d] bg-[#1a1a1a] flex justify-between items-center">
        <div class="text-xs text-gray-400">
          Atualização automática a cada 5 segundos
        </div>
        <button onclick="closeUsageDialog()"
          class="px-4 py-2 bg-[#202020] hover:bg-[#252525] border border-[#2d2d2d] text-gray-300 rounded-lg transition-all duration-200 font-semibold text-sm">
          Fechar
        </button>
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById("searchInput");
    const tableRows = document.querySelectorAll("tbody tr");
    const consoleCards = document.querySelectorAll("[data-console-card]");
    const confirmInput = document.getElementById("confirmInput");
    const errorMessage = document.getElementById("errorMessage");
    let usageInterval = null;

    function reload() {
      setTimeout(() => {
        location.reload();
      }, 50);
    }

    // Busca
    input.addEventListener("input", () => {
      const term = input.value.toLowerCase();

      tableRows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(term) ? "" : "none";
      });

      consoleCards.forEach(card => {
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(term) ? "" : "none";
      });
    });

    // Dialog Stop All
    function openStopAllDialog() {
      document.getElementById("stopAllDialog").classList.remove("hidden");
      document.body.style.overflow = "hidden";
      setTimeout(() => {
        confirmInput.focus();
      }, 100);
    }

    function closeStopAllDialog() {
      document.getElementById("stopAllDialog").classList.add("hidden");
      document.body.style.overflow = "";
      confirmInput.value = "";
      errorMessage.classList.add("hidden");
    }

    function confirmStopAll() {
      const inputValue = confirmInput.value.trim();

      if (inputValue === "CLOSE ALL") {
        window.location.href = "/business/servers/stop/all";
      } else {
        errorMessage.classList.remove("hidden");
        confirmInput.classList.add("border-red-500");
        confirmInput.focus();

        setTimeout(() => {
          confirmInput.classList.remove("border-red-500");
        }, 2000);
      }
    }

    confirmInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        confirmStopAll();
      }
    });


    async function updateUsageData() {
      try {
        const response = await fetch('/business/servers/getUsage');
        const data = await response.json();

        const content = document.getElementById('usageContent');

        if (!data || data.length === 0) {
          content.innerHTML = `
            <div class="text-center text-gray-400 py-8">
              <svg class="w-16 h-16 mx-auto mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              <p class="text-sm">Nenhum servidor em execução</p>
            </div>
          `;
          return;
        }

        let html = '';
        data.forEach(server => {
          const cpuPercent = server.cpu.toFixed(1);
          const ramMB = server.ram.toFixed(1);

          const cpuColor = server.cpu > 80 ? 'red' : server.cpu > 50 ? 'yellow' : 'green';
          const ramColor = server.ram > 500 ? 'red' : server.ram > 300 ? 'yellow' : 'green';

          html += `
    <div class="bg-[#1a1a1a] border border-[#2d2d2d] rounded-xl p-5">
      <div class="flex max-sm:flex-col items-center justify-between mb-4">
        <div class="flex flex-col items-start justify-between mb-3 max-md:w-full">
          <div class="flex-1 min-w-0">
            <a href="http://<%= domain %>:${server.port}" target="_blank"
              class="px-2 py-1 mb-2 bg-blue-500/10 text-blue-400 rounded-md font-mono text-[14px] flex items-center gap-2">
              ${server.businessName}
              <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 122.88 122.88" width="12px" height="12px" class="fill-blue-400">
                <title>hyperlink</title>
                <path
                  d="M60.54,34.07A7.65,7.65,0,0,1,49.72,23.25l13-12.95a35.38,35.38,0,0,1,49.91,0l.07.08a35.37,35.37,0,0,1-.07,49.83l-13,12.95A7.65,7.65,0,0,1,88.81,62.34l13-13a20.08,20.08,0,0,0,0-28.23l-.11-.11a20.08,20.08,0,0,0-28.2.07l-12.95,13Zm14,3.16A7.65,7.65,0,0,1,85.31,48.05L48.05,85.31A7.65,7.65,0,0,1,37.23,74.5L74.5,37.23ZM62.1,89.05A7.65,7.65,0,0,1,72.91,99.87l-12.7,12.71a35.37,35.37,0,0,1-49.76.14l-.28-.27a35.38,35.38,0,0,1,.13-49.78L23,50A7.65,7.65,0,1,1,33.83,60.78L21.12,73.49a20.09,20.09,0,0,0,0,28.25l0,0a20.07,20.07,0,0,0,28.27,0L62.1,89.05Z" />
              </svg>
            </a>
          </div>
          <p class="text-sm text-gray-500">Porta: <span class="text-blue-400 font-mono">${server.port}</span></p>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
          <span class="text-xs font-semibold text-green-400">Online</span>
        </div>
      </div>

      <div class="flex max-md:flex-col gap-2 w-2/4 max-md:w-full">
        <div class="bg-[#0d0d0d] w-2/4 max-md:w-full rounded-lg p-4 border border-${cpuColor}-500/20">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs text-gray-400 uppercase tracking-wider">CPU</span>
            <svg class="w-4 h-4 text-${cpuColor}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
            </svg>
          </div>
          <div class="text-2xl font-bold text-${cpuColor}-400">${cpuPercent}%</div>
          <div class="w-full bg-[#2d2d2d] rounded-full h-2 mt-2">
            <div class="bg-${cpuColor}-500 h-2 rounded-full transition-all duration-300" style="width: ${cpuPercent}%"></div>
          </div>
        </div>

        <div class="bg-[#0d0d0d] w-2/4 max-md:w-full rounded-lg p-4 border border-${ramColor}-500/20">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs text-gray-400 uppercase tracking-wider">RAM</span>
            <svg class="w-4 h-4 text-${ramColor}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
            </svg>
          </div>
          <div class="text-2xl font-bold text-${ramColor}-400">${ramMB}</div>
          <div class="text-xs text-gray-500 mt-1">MB</div>
        </div>
      </div>
    </div>
  `;
        });

        content.innerHTML = html;


      } catch (error) {
        console.error('Erro ao buscar dados de uso:', error);
        document.getElementById('usageContent').innerHTML = `
          <div class="text-center text-red-400 py-8">
            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-sm">Erro ao carregar dados de monitoramento</p>
          </div>
        `;
      }
    }

    function openUsageDialog() {
      document.getElementById("usageDialog").classList.remove("hidden");
      document.body.style.overflow = "hidden";
      updateUsageData();
      usageInterval = setInterval(updateUsageData, 5000);
    }

    function closeUsageDialog() {
      document.getElementById("usageDialog").classList.add("hidden");
      document.body.style.overflow = "";
      if (usageInterval) {
        clearInterval(usageInterval);
        usageInterval = null;
      }
    }

    // ESC para fechar
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeStopAllDialog();
        closeUsageDialog();
      }
    });

    // Copiar JSON
    function copyJSON() {
      const jsonText = document.getElementById("jsonData").textContent;
      navigator.clipboard.writeText(jsonText).then(() => {
        alert(`Copy: ${jsonText}`)
      });
    }

    // Copiar Text
    function copy(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert(`Copy: ${text}`)
      });
    }
  </script>

</body>

</html>