// =====================================================
// üîß PRISMA CONFIGURATION (ENTERPRISE 10/10)
// =====================================================

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =====================================================
// üè¢ TENANT
// =====================================================

model Tenant {
  id     String  @id @default(uuid())
  name   String  @unique @db.VarChar(255)
  active Boolean @default(true)

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Metadata e configura√ß√µes
  metadata Json? @default("{}")
  stats    Json? @default("{}")

  // Rela√ß√µes
  admins             Admin[]
  roles              Role[]
  customers          Customer[]
  sessions           Session[]
  settings           TenantSettings?
  auditLogs          AuditLog[]
  loginAttempts      LoginAttempt[]
  verificationTokens VerificationToken[]

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([active, deletedAt])
  @@index([name, active])
}

// =====================================================
// TENANT SETTINGS
// =====================================================

model TenantSettings {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Configura√ß√µes de seguran√ßa
  sessionDuration        Int     @default(86400) // segundos
  maxLoginAttempts       Int     @default(5)
  lockoutDuration        Int     @default(1800) // segundos
  require2FA             Boolean @default(false)
  passwordMinLength      Int     @default(8)
  passwordRequireSpecial Boolean @default(true)

  // Configura√ß√µes regionais
  timezone String @default("America/Sao_Paulo") @db.VarChar(50)
  currency String @default("BRL") @db.VarChar(3)
  language String @default("pt-BR") @db.VarChar(10)

  // Features habilitadas por tenant
  features Json @default("{}")

  // Limites
  maxAdmins    Int? @default(100)
  maxCustomers Int?

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?
}

// =====================================================
// ENUMS
// =====================================================

enum AdminType {
  SERVER
  BUSINESS
}

enum Resource {
  PRODUCT
  ORDER
  FINANCE
  CUSTOMER
  SUPPORT
  ADMINS
  OWNER
}

enum PermissionAction {
  VIEW
  CREATE
  UPDATE
  DELETE
  MANAGE
}

enum LoginType {
  PHONE_ONLY
  EMAIL_PASSWORD
  EMAIL_PASSWORD_2FA
}

enum SessionOwnerType {
  ADMIN
  CUSTOMER
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  PERMISSION_CHANGE
}

enum TokenType {
  PASSWORD_RESET
  EMAIL_VERIFY
  PHONE_VERIFY
  TWO_FACTOR
}

// =====================================================
// ROLES & PERMISSIONS
// =====================================================

model Role {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String  @db.VarChar(255)
  description String? @db.Text

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  permissions RolePermission[]
  admins      Admin[]

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([tenantId, name])
  @@index([tenantId, deletedAt])
  @@index([tenantId, name, deletedAt])
}

model RolePermission {
  id String @id @default(uuid())

  resource Resource
  action   PermissionAction

  attributes Json? @default("{}")

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([roleId, resource, action])
  @@index([roleId])
  @@index([resource, action])
  @@index([roleId, resource])
}

// =====================================================
// ADMIN
// =====================================================

model Admin {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name         String    @db.VarChar(255)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @db.VarChar(255)
  type         AdminType

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Restrict)

  // Controle de acesso
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?

  // 2FA
  twoFactorSecret  String? @db.VarChar(255)
  twoFactorEnabled Boolean @default(false)

  // Recovery
  recoveryCodes Json? // array de c√≥digos hash

  // Password tracking
  passwordChangedAt DateTime?
  passwordExpiresAt DateTime?

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  sessions           Session[]
  verificationTokens VerificationToken[]

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([tenantId, deletedAt])
  @@index([tenantId, roleId, deletedAt])
  @@index([type, isActive, deletedAt])
  @@index([email, isActive])
  @@index([tenantId, isActive, type])
}

// =====================================================
// CUSTOMER
// =====================================================

model Customer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name    String  @db.VarChar(255)
  phone   String  @unique @db.VarChar(20)
  address String? @db.Text

  // Status
  isActive Boolean @default(true)

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Metadata
  metadata Json? @default("{}")

  logins             CustomerLogin[]
  sessions           Session[]
  verificationTokens VerificationToken[]

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([tenantId, phone, deletedAt])
  @@index([tenantId, isActive, deletedAt])
  @@index([phone, isActive])
}

model CustomerLogin {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type         LoginType
  email        String?   @db.VarChar(255)
  passwordHash String?   @db.VarChar(255)

  // Verifica√ß√£o
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Controle de acesso
  lastLogin     DateTime?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?

  // 2FA
  twoFactorSecret  String? @db.VarChar(255)
  twoFactorEnabled Boolean @default(false)

  // Recovery codes
  recoveryCodes Json? // array de c√≥digos hash

  // Password tracking
  passwordChangedAt DateTime?
  passwordExpiresAt DateTime?

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([customerId, type, deletedAt])
  @@index([customerId, deletedAt])
  @@index([email, deletedAt])
  @@index([type, isVerified, deletedAt])
  @@index([email, isVerified])
}

// =====================================================
// SESSION
// =====================================================

model Session {
  id    String @id @default(uuid())
  token String @unique @db.VarChar(255)

  ownerType SessionOwnerType

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  adminId    String?
  admin      Admin?    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Informa√ß√µes de contexto
  ip    String? @db.VarChar(45)
  agent String? @db.Text
  city  String? @db.VarChar(255)

  // Device fingerprint
  deviceId   String? @db.VarChar(255)
  deviceName String? @db.VarChar(255)

  // Status
  active     Boolean   @default(true)
  expiresAt  DateTime
  verifiedAt DateTime?
  lastUsedAt DateTime  @default(now())

  // Auditoria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token, active])
  @@index([adminId, active, expiresAt])
  @@index([customerId, active, expiresAt])
  @@index([active, expiresAt])
  @@index([ownerType, active])
  @@index([tenantId, active, expiresAt])
  @@index([tenantId, ownerType, active])
  @@index([deviceId, active])
}

// =====================================================
// AUDIT LOG
// =====================================================

model AuditLog {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Entidade afetada
  entityType String @db.VarChar(100) // "Admin", "Customer", "Role", etc
  entityId   String @db.VarChar(255)

  // A√ß√£o realizada
  action      AuditAction
  description String?     @db.Text

  // Quem executou
  performedBy     String           @db.VarChar(255) // adminId ou customerId
  performedByType SessionOwnerType

  // Dados da mudan√ßa
  changes Json? // {before: {...}, after: {...}}

  // Contexto da requisi√ß√£o
  ip        String? @db.VarChar(45)
  agent     String? @db.Text
  sessionId String? @db.VarChar(255)

  // Metadata adicional
  metadata Json? @default("{}")

  createdAt DateTime @default(now())

  @@index([tenantId, entityType, entityId, createdAt])
  @@index([performedBy, createdAt])
  @@index([createdAt])
  @@index([tenantId, action, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([tenantId, performedBy, createdAt])
}

// =====================================================
// LOGIN ATTEMPTS
// =====================================================

model LoginAttempt {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  identifier String           @db.VarChar(255) // email ou phone
  type       SessionOwnerType

  success Boolean
  reason  String? @db.VarChar(255) // "INVALID_PASSWORD", "ACCOUNT_LOCKED", "2FA_FAILED", etc

  // Contexto
  ip        String  @db.VarChar(45)
  agent String? @db.Text
  deviceId  String? @db.VarChar(255)

  // Metadata
  metadata Json? @default("{}")

  createdAt DateTime @default(now())

  @@index([identifier, createdAt])
  @@index([tenantId, success, createdAt])
  @@index([tenantId, identifier, success, createdAt])
  @@index([ip, createdAt])
  @@index([success, createdAt])
}

// =====================================================
// VERIFICATION TOKENS
// =====================================================

model VerificationToken {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  token String    @unique @db.VarChar(255)
  type  TokenType

  // Owner do token
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  adminId String?
  admin   Admin?  @relation(fields: [adminId], references: [id], onDelete: Cascade)

  // Status
  used      Boolean   @default(false)
  usedAt    DateTime?
  expiresAt DateTime

  // Contexto de uso
  usedFromIp String? @db.VarChar(45)
  metadata   Json?   @default("{}")

  createdAt DateTime @default(now())

  @@index([token, used, expiresAt])
  @@index([customerId, type, used, expiresAt])
  @@index([adminId, type, used, expiresAt])
  @@index([type, used, expiresAt])
  @@index([tenantId, type, used, createdAt])
}
