datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model AdminForBusiness {
  id           String    @id @default(uuid())
  adminName    String
  email        String    @unique @db.VarChar(191)
  password     String    @db.VarChar(255)
  role         String    @default("employee") // ‚úÖ Correto
  createdAt    DateTime  @default(now())
  businessId   String
  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Business {
  id         String             @id @default(uuid())
  businessName       String
  cnpj       String             @unique @db.VarChar(18)
  port       Int                @unique
  domain     String             @unique
  secret     String             @unique @db.Char(64)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  admins     AdminForBusiness[]
  settings   BusinessSettings[]
  user       User[]
  logs       BusinessLog[]
  tickets    Ticket[]
  products   Product[] // produtos da empresa
  categories Category[] // üî• rela√ß√£o inversa das categorias
}

model Category {
  id         String    @id @default(uuid())
  label      String    @unique // ex: "Lanches", "Bebidas", "Diversos"
  icon       String? // opcional, ex: "üçî"
  businessId String
  business   Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  products   Product[] // rela√ß√£o com os produtos dessa categoria
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([businessId])
}

model Product {
  id          String    @id @default(uuid())
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  productName        String
  image       String
  description String?   @db.MediumText
  isPopular   Boolean?  @default(false)
  prepTime    Int?
  price       Float
  stock       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([businessId])
  @@index([categoryId])
}

model Ticket {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  items      Json // armazenar os itens do pedido
  total      Float
  status     String // ex: "pending", "completed", "canceled"
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([businessId])
}

model BusinessSettings {
  id         String   @id @default(uuid())
  data       Json
  businessId String   @unique
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model AdminForServer {
  id        String    @id @default(uuid())
  adminName      String
  email     String    @unique @db.VarChar(191)
  verify    Boolean   @default(false)
  password  String    @db.VarChar(255)
  createdAt DateTime  @default(now())
  sessions  Session[]
}

model User {
  id         String   @id @default(uuid())
  customerName       String
  phone      String   @unique @db.VarChar(15)
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  tickets    Ticket[] // relaciona os pedidos do usu√°rio

  @@index([businessId])
}

model Session {
  id        String         @id @default(uuid())
  uuid      String         @unique
  userId    String
  user      AdminForServer @relation(fields: [userId], references: [id], onDelete: Cascade)
  active    Boolean        @default(true)
  expiresAt DateTime // permite seguran√ßa real
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([userId])
}

//
// üî• Novas tabelas √∫teis
//

// üìå Log do Business ‚Äî auditoria, hist√≥rico de a√ß√µes
model BusinessLog {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  action     String
  ip         String?
  createdAt  DateTime @default(now())

  @@index([businessId])
}
